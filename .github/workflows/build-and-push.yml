name: Workflow SF7 API
on:
  push:
    branches: [main]

defaults:
 run:
  working-directory: ./api

jobs:
  symfony_tests:
    runs-on: ubuntu-latest
    environment: test
    name: Symfony 7 PHP 8
    services:
      mysql:
        image: mysql:8.4.3
        ports:
          - 3306:3306
        env:
          MYSQL_ROOT_PASSWORD: root_password_mysql
          MYSQL_USER: app
          MYSQL_PASSWORD: password_mysql
        options: >-
          --health-cmd="mysqladmin ping -h localhost --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
          --name mysql-server
        volumes:
          - ./docker/mysql/init:/docker-entrypoint-initdb.d
    strategy:
      fail-fast: true
    steps:
      # â€”â€” Setup Github actions ðŸ™ â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # https://github.com/actions/checkout (official)
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Symfony
        run: |
          curl -1sLf 'https://dl.cloudsmith.io/public/symfony/stable/setup.deb.sh' | sudo -E bash
          sudo apt-get update && sudo apt-get install -y symfony-cli

      # https://github.com/shivammathur/setup-php (community)
      - name: Setup PHP, extensions and composer with shivammathur/setup-php
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4' 
          extensions: mbstring, xml, ctype, iconv, intl, pdo, pdo_mysql, dom, filter, json, curl, amqp
        env:
          update: true

      - name: Check PHP Version
        run: php -v
        
      # â€”â€” Composer ðŸ§™â€ï¸ â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: Validate composer.json and composer.lock
        run: composer validate

      - name: Cache Composer packages
        id: composer-cache
        uses: actions/cache@v4
        with:
          path: "$PWD/vendor"
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-

      - name: Install Dependencies
        run: composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist

      # â€”â€” Symfony ðŸŽµ â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: Prepare .env file
        run: |
          echo "APP_ENV=${{ vars.APP_ENV }}" >> .env.test
          echo "APP_DEBUG=${{ vars.APP_DEBUG }}" >> .env.test 
          echo "APP_SECRET=$(openssl rand -hex 16)" >> .env.test 
          echo "JWT_SECRET='${{ secrets.JWT_SECRET }}'" >> .env.test 
          echo "MESSENGER_TRANSPORT_DSN=${{ secrets.MESSENGER_TRANSPORT_DSN }}" >> .env.test 
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> .env.test 
          echo "CORS_ALLOW_ORIGIN='${{ secrets.CORS_ALLOW_ORIGIN }}'" >> .env.test 
          echo "KERNEL_CLASS='${{ vars.KERNEL_CLASS }}'" >> .env.test
          echo "SYMFONY_DEPRECATIONS_HELPER=${{ vars.SYMFONY_DEPRECATIONS_HELPER }}" >> .env.test
          echo "PANTHER_APP_ENV='${{ vars.PANTHER_APP_ENV }}" >> .env.test
          echo "PANTHER_ERROR_SCREENSHOT_DIR='${{ vars.PANTHER_ERROR_SCREENSHOT_DIR }}" >> .env.test
           
      - name: Check Symfony requirements
        run: symfony check:requirements
          
      - name: Check the Symfony version and environnements
        run: php bin/console --version
      
      - name: Run database migrations
        run: php bin/console doctrine:migrations:migrate --env=test --no-interaction

      - name: Static analysis of PHP code (PHPStan)
        run: |
          ./vendor/bin/phpstan analyse --configuration=phpstan.dist.neon --memory-limit=512M
        continue-on-error: true
      
      ## â€”â€” Tests âœ… â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: Run functionnal and unit tests
        run: |
          ./vendor/bin/phpunit

      # â€”â€” Artifact â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: Delete .env
        run: |
          rm -f .env.test

      - name: Archive test artifact
        uses: actions/upload-artifact@v4
        with:
          name: $(basename $PWD)-${{ job.environment }}-${{ github.run_id }}-artifact
          path: .
          retention-days: 1
          